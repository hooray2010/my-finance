<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­é›²ç«¯å¸³æœ¬ - æ™ºæ…§å¸³æœŸç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2ecc71; --danger: #e74c3c; --warning: #f1c40f; --dark: #2c3e50; --gray: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--gray); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .month-selector { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .month-selector select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; font-weight: bold; width: 100%; background: white; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .value { font-size: 1.5rem; font-weight: bold; color: var(--dark); display: block; margin-top: 5px; }
        .label { font-size: 0.8rem; color: #888; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-food { background: #ff7675; margin-bottom: 15px; }
        .btn-other { background: #74b9ff; }
        #adminPanel { display: none; margin-top: 20px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .admin-toggle { background: none; color: #aaa; font-size: 12px; border: 1px solid #eee; padding: 5px; margin-top: 50px; width: auto; }
        .item-row { display: grid; grid-template-columns: 1fr 100px 40px; gap: 5px; margin-bottom: 5px; }
        .delete-btn { background: #ff7675; padding: 5px; font-size: 12px; border: none; border-radius: 4px; color: white; }
        .cloud-status { text-align: center; font-size: 12px; color: #2ecc71; margin-bottom: 5px; }
        pre#rawDataDisplay { background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 8px; font-size: 11px; overflow-x: auto; max-height: 200px; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" class="cloud-status">é›²ç«¯åŒæ­¥ä¸­...</div>

    <div class="month-selector">
        <select id="currentMonth" onchange="switchMonth()"></select>
    </div>

    <div class="stat-grid">
        <div class="stat-box">
            <span class="label">é ä¼°å‰©é¤˜è–ªè³‡</span>
            <span id="netSavings" class="value">$0</span>
        </div>
        <div class="stat-box">
            <span class="label">ç”Ÿæ´»è²»é¤˜é¡</span>
            <span id="livingLeft" class="value">$0</span>
        </div>
    </div>

    <div class="card"><canvas id="budgetChart" style="max-height: 180px;"></canvas></div>

    <div class="card">
        <h3 style="margin-top:0">ğŸ” ç´€éŒ„åƒå– (10è™Ÿèµ·ç®—)</h3>
        <input type="number" id="foodAmount" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
        <button class="btn-food" onclick="addExpense('food')">ç¢ºèªç´€éŒ„</button>

        <h3 style="margin-top:10px">ğŸ“¦ ç´€éŒ„å…¶ä»–æ”¯å‡º</h3>
        <input type="number" id="otherAmount" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
        <input type="text" id="otherNote" placeholder="å‚™è¨» (ä¾‹å¦‚: è²·è¡£æœ)">
        <button class="btn-other" onclick="addExpense('other')">ç¢ºèªç´€éŒ„</button>
    </div>

    <center><button class="admin-toggle" onclick="toggleAdmin()">âš™ï¸ ç®¡ç†å“¡èˆ‡ Raw Data</button></center>

    <div id="adminPanel">
        <div class="card">
            <h3>ğŸ’° é ç®—ç®¡ç† (æœ¬æœŸè¨­å®š)</h3>
            <label class="label">ç¸½è–ªè³‡</label><input type="number" id="salary" onchange="triggerUpdate()">
            <label class="label">ç”Ÿæ´»è²»ä¸Šé™</label><input type="number" id="livingLimit" onchange="triggerUpdate()">
            
            <label class="label">å¿…è¦é–‹éŠ·é …ç›®</label>
            <div id="fixedItemsContainer"></div>
            <button style="background: #3498db; font-size: 13px; padding: 8px;" onclick="addFixedItemRow()">+ æ–°å¢é …ç›®</button>
        </div>

        <div class="card">
            <h3>ğŸ” Cloud Raw Data (JSON)</h3>
            <pre id="rawDataDisplay">ç­‰å¾…æ•¸æ“š...</pre>
        </div>

        <button style="background:#aaa; margin-top: 10px; font-size: 12px;" onclick="resetData()">ğŸš¨ æ¸…ç©ºç›®å‰é¡¯ç¤ºå¸³æœŸæ•¸æ“š</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCgMm4JQ95mH-JOAcBsnlHz9Q7ceiF3H2E",
        authDomain: "my-finance-app-99fda.firebaseapp.com",
        projectId: "my-finance-app-99fda",
        storageBucket: "my-finance-app-99fda.firebasestorage.app",
        messagingSenderId: "476029346804",
        appId: "1:476029346804:web:84edfef6015a3900270fa1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentData = { salary: 50000, fixedItems: [], limit: 12000, spentFood: 0, spentOther: 0, otherLogs: [] };
    let chart;
    let unsubscribe = null;
    const BILLING_START_DAY = 10;

    // --- æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤å®šæ—¥æœŸå±¬æ–¼å“ªå€‹å¸³æœŸ ---
    function getBillingMonth(date) {
        let year = date.getFullYear();
        let month = date.getMonth();
        if (date.getDate() < BILLING_START_DAY) {
            month -= 1;
            if (month < 0) { month = 11; year -= 1; }
        }
        return `${year}-${String(month + 1).padStart(2, '0')}`;
    }

    function initMonthSelector() {
        const selector = document.getElementById('currentMonth');
        const now = new Date();
        const targetValue = getBillingMonth(now);

        for (let i = -3; i <= 6; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            const monthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            
            const option = document.createElement('option');
            option.value = monthStr; 
            // é¡¯ç¤ºæ–‡å­—è¼”åŠ©ç†è§£
            const displayMonth = d.getMonth() + 1;
            const nextMonth = displayMonth === 12 ? 1 : displayMonth + 1;
            option.text = `${monthStr} å¸³æœŸ (${displayMonth}/10 - ${nextMonth}/9)`;
            
            if (monthStr === targetValue) option.selected = true;
            selector.appendChild(option);
        }
    }

    window.switchMonth = () => {
        const month = document.getElementById('currentMonth').value;
        if (unsubscribe) unsubscribe();
        const docRef = doc(db, "family_account_v3", month);
        
        unsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                currentData = docSnap.data();
            } else {
                // æ–°å¸³æœŸé è¨­ç¹¼æ‰¿ä¸ŠæœŸé ç®—é…ç½®
                currentData = { ...currentData, spentFood: 0, spentOther: 0, otherLogs: [] };
            }
            renderUI();
            document.getElementById('status').innerText = `âœ… å·²åˆ‡æ›è‡³ ${month} å¸³æœŸ`;
        });
    };

    function renderUI() {
        const salary = parseFloat(currentData.salary) || 0;
        const limit = parseFloat(currentData.limit) || 0;
        const spentFood = parseFloat(currentData.spentFood) || 0;
        const spentOther = parseFloat(currentData.spentOther) || 0;
        const totalSpent = spentFood + spentOther;
        
        document.getElementById('salary').value = salary;
        document.getElementById('livingLimit').value = limit;
        document.getElementById('rawDataDisplay').innerText = JSON.stringify(currentData, null, 2);

        const container = document.getElementById('fixedItemsContainer');
        container.innerHTML = '';
        (currentData.fixedItems || []).forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `<input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)"><input type="number" value="${item.amount}" onchange="updateItem(${index}, 'amount', this.value)"><button class="delete-btn" onclick="removeFixedItem(${index})">âœ•</button>`;
            container.appendChild(row);
        });

        const totalFixed = (currentData.fixedItems || []).reduce((sum, i) => sum + (parseFloat(i.amount) || 0), 0);
        const netBalance = salary - totalFixed - limit;
        const livingRemaining = limit - totalSpent;

        document.getElementById('netSavings').innerText = `$${Math.round(netBalance).toLocaleString()}`;
        document.getElementById('livingLeft').innerText = `$${Math.round(livingRemaining).toLocaleString()}`;

        const ctx = document.getElementById('budgetChart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['å¿…è¦é–‹éŠ·', 'åƒå–', 'å…¶ä»–', 'é è¨ˆå­˜æ¬¾'],
                datasets: [{ 
                    data: [totalFixed, spentFood, spentOther, Math.max(0, netBalance)], 
                    backgroundColor: ['#3498db', '#ff7675', '#74b9ff', '#2ecc71'] 
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
    }

    // --- ä¿®æ”¹ï¼šå„²å­˜æ™‚è‡ªå‹•åˆ¤å®šå¸³æœŸ ---
    window.addExpense = async (type) => {
        const inputId = type === 'food' ? 'foodAmount' : 'otherAmount';
        const val = parseFloat(document.getElementById(inputId).value) || 0;
        if (val <= 0) return;

        const now = new Date();
        const targetMonth = getBillingMonth(now); // è‡ªå‹•åˆ¤æ–· 10 è™Ÿå¸³æœŸ
        const docRef = doc(db, "family_account_v3", targetMonth);
        
        document.getElementById('status').innerText = `â³ æ­£åœ¨å­˜å…¥ ${targetMonth}...`;

        const docSnap = await getDoc(docRef);
        let targetData = docSnap.exists() ? docSnap.data() : { ...currentData, spentFood: 0, spentOther: 0, otherLogs: [] };

        if (type === 'food') {
            targetData.spentFood = (parseFloat(targetData.spentFood) || 0) + val;
        } else {
            targetData.spentOther = (parseFloat(targetData.spentOther) || 0) + val;
            const note = document.getElementById('otherNote').value;
            if (!targetData.otherLogs) targetData.otherLogs = [];
            targetData.otherLogs.push({ amount: val, note, time: now.toLocaleString() });
        }

        await setDoc(docRef, targetData);
        
        document.getElementById(inputId).value = '';
        if (type === 'other') document.getElementById('otherNote').value = '';
        
        // è‹¥ç•¶å‰æ­£æŸ¥çœ‹è©²å¸³æœŸï¼ŒonSnapshot æœƒè‡ªå‹• renderUI
        // è‹¥æŸ¥çœ‹çš„æ˜¯åˆ¥æœˆï¼Œå‰‡è·³è½‰éå»
        if (document.getElementById('currentMonth').value !== targetMonth) {
            document.getElementById('currentMonth').value = targetMonth;
            switchMonth();
        }
        alert(`æˆåŠŸï¼å·²è¨˜éŒ„è‡³ ${targetMonth} å¸³æœŸ`);
    };

    window.save = async () => {
        const month = document.getElementById('currentMonth').value;
        await setDoc(doc(db, "family_account_v3", month), currentData);
    };

    window.toggleAdmin = () => {
        const panel = document.getElementById('adminPanel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    };

    window.triggerUpdate = () => {
        currentData.salary = parseFloat(document.getElementById('salary').value) || 0;
        currentData.limit = parseFloat(document.getElementById('livingLimit').value) || 0;
        window.save();
    };

    window.updateItem = (index, field, value) => {
        currentData.fixedItems[index][field] = field === 'amount' ? parseFloat(value) || 0 : value;
        window.save();
    };

    window.addFixedItemRow = () => {
        if (!currentData.fixedItems) currentData.fixedItems = [];
        currentData.fixedItems.push({name: '', amount: 0});
        window.save();
    };

    window.removeFixedItem = (index) => {
        currentData.fixedItems.splice(index, 1);
        window.save();
    };

    window.resetData = async () => {
        if (confirm('ç¢ºå®šé‡ç½®ç›®å‰é¡¯ç¤ºå¸³æœŸçš„æ•¸æ“šï¼Ÿ')) {
            currentData.spentFood = 0; currentData.spentOther = 0; currentData.otherLogs = []; window.save();
        }
    };

    initMonthSelector();
    switchMonth();
</script>
</body>
</html>