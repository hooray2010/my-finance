<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯è¨˜å¸³ - åˆ†é¡é€²éšç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2ecc71; --danger: #e74c3c; --warning: #f1c40f; --dark: #2c3e50; --gray: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--gray); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .month-selector { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .month-selector select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; font-weight: bold; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .value { font-size: 1.5rem; font-weight: bold; color: var(--dark); display: block; margin-top: 5px; }
        .label { font-size: 0.8rem; color: #888; }
        input, select.input-field { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-food { background: #ff7675; }
        .btn-other { background: #74b9ff; }
        .item-row { display: grid; grid-template-columns: 1fr 100px 40px; gap: 5px; margin-bottom: 5px; }
        .delete-btn { background: #ff7675; padding: 5px; font-size: 12px; border: none; border-radius: 4px; color: white; }
        .cloud-status { text-align: center; font-size: 12px; color: #2ecc71; margin-bottom: 5px; }
        .raw-data-area { background: #273036; color: #3ae374; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; white-space: pre-wrap; display: none; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>â˜ï¸ é›²ç«¯åˆ†é¡ Dashboard</h2>
    <div id="status" class="cloud-status">æ­£åœ¨åŒæ­¥...</div>

    <div class="month-selector">
        <label>é¸æ“‡æœˆä»½ï¼š</label>
        <select id="currentMonth" onchange="switchMonth()"></select>
    </div>

    <div class="stat-grid">
        <div class="stat-box"><span class="label">æœ¬æœˆå‰©é¤˜è–ªè³‡</span><span id="netSavings" class="value">$0</span></div>
        <div class="stat-box"><span class="label">ç”Ÿæ´»è²»é¤˜é¡</span><span id="livingLeft" class="value">$0</span></div>
    </div>

    <div class="card"><canvas id="budgetChart" style="max-height: 180px;"></canvas></div>

    <div class="card">
        <h3>å¿«é€Ÿè¨˜å¸³</h3>
        
        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ffeaa7; border-radius: 10px;">
            <span class="label">ğŸ” åƒå– (è‡ªå‹•ç´€éŒ„)</span>
            <input type="number" id="foodAmount" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
            <button class="btn-food" onclick="addExpense('food')">ç´€éŒ„åƒå–</button>
        </div>

        <div style="padding: 10px; border: 1px solid #dfe6e9; border-radius: 10px;">
            <span class="label">ğŸ“¦ å…¶ä»– (å¯å¡«å‚™è¨»)</span>
            <input type="number" id="otherAmount" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
            <input type="text" id="otherNote" placeholder="å‚™è¨» (ä¾‹å¦‚: è²·è¡£æœã€çœ‹é›»å½±)">
            <button class="btn-other" onclick="addExpense('other')">ç´€éŒ„å…¶ä»–</button>
        </div>
    </div>

    <div class="card">
        <h3>é ç®—èˆ‡å¿…è¦é–‹éŠ·è©³åˆ—</h3>
        <label class="label">è–ªè³‡</label><input type="number" id="salary" onchange="triggerUpdate()">
        <div id="fixedItemsContainer"></div>
        <button style="background: #3498db; font-size: 13px; padding: 8px;" onclick="addFixedItemRow()">+ æ–°å¢å›ºå®šé …ç›®</button>
        <hr style="margin: 20px 0; border: 0.5px solid #eee;">
        <label class="label">ç”Ÿæ´»è²»ä¸Šé™</label><input type="number" id="livingLimit" onchange="triggerUpdate()">
    </div>

    <button style="background: #34495e; font-size: 12px;" onclick="toggleRawData()">é¡¯ç¤ºé›²ç«¯ JSON</button>
    <div id="rawData" class="raw-data-area"></div>
    <button style="background:#aaa; margin-top: 10px; font-size: 12px;" onclick="resetData()">æ¸…ç©ºæœ¬æœˆæ•¸æ“š</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ è«‹åœ¨æ­¤æ›¿æ›æˆä½ è‡ªå·±çš„ Firebase Config ğŸ”´
    const firebaseConfig = {
    apiKey: "AIzaSyCgMm4JQ95mH-JOAcBsnlHz9Q7ceiF3H2E",
    authDomain: "my-finance-app-99fda.firebaseapp.com",
    projectId: "my-finance-app-99fda",
    storageBucket: "my-finance-app-99fda.firebasestorage.app",
    messagingSenderId: "476029346804",
    appId: "1:476029346804:web:84edfef6015a3900270fa1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let currentData = { salary: 50000, fixedItems: [], limit: 15000, spentFood: 0, spentOther: 0, otherLogs: [] };
    let chart;
    let unsubscribe = null;

    function initMonthSelector() {
        const selector = document.getElementById('currentMonth');
        const now = new Date();
        for (let i = -6; i <= 6; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            const monthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const option = document.createElement('option');
            option.value = monthStr;
            option.text = monthStr;
            if (i === 0) option.selected = true;
            selector.appendChild(option);
        }
    }

    window.switchMonth = () => {
        const month = document.getElementById('currentMonth').value;
        if (unsubscribe) unsubscribe();
        const docRef = doc(db, "family_account_v3", month);
        unsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                currentData = docSnap.data();
            } else {
                currentData = { salary: 50000, fixedItems: [], limit: 15000, spentFood: 0, spentOther: 0, otherLogs: [] };
            }
            renderUI();
            document.getElementById('status').innerText = `âœ… ${month} åŒæ­¥ä¸­`;
            document.getElementById('rawData').innerText = JSON.stringify(currentData, null, 4);
        });
    };

function renderUI() {
    // ç¢ºä¿æ•¸å€¼è½‰ç‚ºæ•¸å­—ï¼Œé¿å…å­—ä¸²ç›¸åŠ 
    const salary = Number(currentData.salary) || 0;
    const limit = Number(currentData.limit) || 0;
    const spentFood = Number(currentData.spentFood) || 0;
    const spentOther = Number(currentData.spentOther) || 0;
    
    // è¨ˆç®—å›ºå®šé–‹éŠ·ç¸½é¡
    const totalFixed = (currentData.fixedItems || []).reduce((sum, i) => {
        return sum + (Number(i.amount) || 0);
    }, 0);

    const totalSpent = spentFood + spentOther; // ç¸½ç”Ÿæ´»è²»æ”¯å‡º
    const netBalance = salary - totalFixed - limit; // è–ªè³‡å‰©é¤˜
    const livingRemaining = limit - totalSpent; // ç”Ÿæ´»è²»å‰©é¤˜

    // æ›´æ–°ä»‹é¢ï¼ŒåŠ ä¸Š Math.round ç¢ºä¿é¡¯ç¤ºæ•´æ•¸ï¼Œé¿å… .0000000001 çš„ç‹€æ³
    document.getElementById('netSavings').innerText = `$${Math.round(netBalance).toLocaleString()}`;
    document.getElementById('livingLeft').innerText = `$${Math.round(livingRemaining).toLocaleString()}`;

    // æ›´æ–°åœ“é¤…åœ– (ä½¿ç”¨ç›¸åŒè®Šæ•¸ç¢ºä¿åŒæ­¥)
    const ctx = document.getElementById('budgetChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['å¿…è¦', 'åƒå–', 'å…¶ä»–', 'å‰©é¤˜å­˜æ¬¾'],
            datasets: [{ 
                data: [totalFixed, spentFood, spentOther, Math.max(0, netBalance)], 
                backgroundColor: ['#3498db', '#ff7675', '#74b9ff', '#2ecc71'] 
            }]
        }
    });
}

    async function save() {
        const month = document.getElementById('currentMonth').value;
        await setDoc(doc(db, "family_account_v3", month), currentData);
    }

    window.addExpense = async (type) => {
        if (type === 'food') {
            const amount = parseFloat(document.getElementById('foodAmount').value) || 0;
            if (amount > 0) {
                currentData.spentFood = (currentData.spentFood || 0) + amount;
                document.getElementById('foodAmount').value = '';
                await save();
            }
        } else {
            const amount = parseFloat(document.getElementById('otherAmount').value) || 0;
            const note = document.getElementById('otherNote').value;
            if (amount > 0) {
                currentData.spentOther = (currentData.spentOther || 0) + amount;
                if (!currentData.otherLogs) currentData.otherLogs = [];
                currentData.otherLogs.push({ amount, note, time: new Date().toLocaleString() });
                document.getElementById('otherAmount').value = '';
                document.getElementById('otherNote').value = '';
                await save();
            }
        }
    };

    window.triggerUpdate = () => {
        currentData.salary = parseFloat(document.getElementById('salary').value) || 0;
        currentData.limit = parseFloat(document.getElementById('livingLimit').value) || 0;
        save();
    };

    window.updateItem = (index, field, value) => {
        currentData.fixedItems[index][field] = field === 'amount' ? parseFloat(value) || 0 : value;
        save();
    };

    window.addFixedItemRow = () => {
        if (!currentData.fixedItems) currentData.fixedItems = [];
        currentData.fixedItems.push({name: '', amount: 0});
        save();
    };

    window.removeFixedItem = (index) => {
        currentData.fixedItems.splice(index, 1);
        save();
    };

    window.toggleRawData = () => {
        const area = document.getElementById('rawData');
        area.style.display = area.style.display === 'none' ? 'block' : 'none';
    };

    window.resetData = async () => {
        if (confirm('ç¢ºå®šé‡ç½®æœ¬æœˆæ•¸æ“šï¼Ÿ')) {
            currentData.spentFood = 0;
            currentData.spentOther = 0;
            currentData.otherLogs = [];
            save();
        }
    };

    initMonthSelector();
    switchMonth();
</script>
</body>
</html>