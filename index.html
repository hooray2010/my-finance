<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­é›²ç«¯å¸³æœ¬ - æœ€çµ‚æ•´åˆç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2ecc71; --danger: #e74c3c; --warning: #f1c40f; --dark: #2c3e50; --gray: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--gray); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .month-selector { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .month-selector select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; font-weight: bold; width: 100%; background: white; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .value { font-size: 1.5rem; font-weight: bold; color: var(--dark); display: block; margin-top: 5px; }
        .label { font-size: 0.8rem; color: #888; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-food { background: #ff7675; margin-bottom: 15px; }
        .btn-other { background: #74b9ff; }
        #adminPanel { display: none; margin-top: 20px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .admin-toggle { background: none; color: #aaa; font-size: 12px; border: 1px solid #eee; padding: 5px; margin-top: 50px; width: auto; }
        .item-row { display: grid; grid-template-columns: 1fr 100px 40px; gap: 5px; margin-bottom: 5px; }
        .delete-btn { background: #ff7675; padding: 5px; font-size: 12px; border: none; border-radius: 4px; color: white; }
        .cloud-status { text-align: center; font-size: 12px; color: #2ecc71; margin-bottom: 5px; }
        pre#rawDataDisplay { background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 8px; font-size: 11px; overflow-x: auto; max-height: 200px; text-align: left; }
        .log-list { font-size: 13px; color: #555; padding-left: 0px; max-height: 200px; overflow-y: auto; }
        .log-item { padding: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" class="cloud-status">é›²ç«¯åŒæ­¥ä¸­...</div>

    <div class="month-selector">
        <select id="currentMonth" onchange="switchMonth()"></select>
    </div>

    <div class="stat-grid">
        <div class="stat-box">
            <span class="label">é ä¼°å‰©é¤˜è–ªè³‡</span>
            <span id="netSavings" class="value">$0</span>
        </div>
        <div class="stat-box">
            <span class="label">ç”Ÿæ´»è²»é¤˜é¡</span>
            <span id="livingLeft" class="value">$0</span>
        </div>
    </div>

    <div class="card"><canvas id="budgetChart" style="max-height: 180px;"></canvas></div>

    <div class="card" id="detailCard" style="display:none;">
        <h3 style="margin:0 0 10px 0; font-size: 16px;">ğŸ“ æœ¬æœŸæ˜ç´° (10è™Ÿèµ·ç®—)</h3>
        <div id="combinedLogs" class="log-list"></div>
    </div>

    <div class="card">
        <h3 style="margin-top:0">ğŸ” ç´€éŒ„åƒå–</h3>
        <input type="number" id="foodAmount" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
        <button class="btn-food" onclick="addExpense('food')">ç¢ºèªç´€éŒ„</button>

        <h3 style="margin-top:10px">ğŸ“¦ ç´€éŒ„å…¶ä»–æ”¯å‡º</h3>
        <input type="number" id="otherAmount" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
        <input type="text" id="otherNote" placeholder="å‚™è¨» (ä¾‹å¦‚: è²·è¡£æœ)">
        <button class="btn-other" onclick="addExpense('other')">ç¢ºèªç´€éŒ„</button>
    </div>

    <center><button class="admin-toggle" onclick="toggleAdmin()">âš™ï¸ ç®¡ç†å“¡èˆ‡é›²ç«¯è¨­å®š</button></center>

    <div id="adminPanel">
        <div class="card">
            <h3>ğŸ’° é ç®—ç®¡ç†</h3>
            <label class="label">ç¸½è–ªè³‡</label><input type="number" id="salary" onchange="triggerUpdate()">
            <label class="label">ç”Ÿæ´»è²»ä¸Šé™</label><input type="number" id="livingLimit" onchange="triggerUpdate()">
            <div id="fixedItemsContainer"></div>
            <button style="background: #3498db; font-size: 13px; padding: 8px;" onclick="addFixedItemRow()">+ æ–°å¢å¿…è¦é–‹éŠ·</button>
        </div>
        <div class="card">
            <h3>ğŸ” Firebase Raw Data</h3>
            <pre id="rawDataDisplay"></pre>
        </div>
        <button style="background:#aaa; margin-top: 10px; font-size: 12px;" onclick="resetData()">ğŸš¨ é‡ç½®æœ¬æœŸæ•¸æ“š</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- è¨­å®šå€ ---
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbxgIXPEQLKINxnmGCUYbINmvW6cGK7c6EU4AzeYFOWM0jZeIU7cr7c6KXoThpuXDe0/exec"; 
    const firebaseConfig = {
        apiKey: "AIzaSyCgMm4JQ95mH-JOAcBsnlHz9Q7ceiF3H2E",
        authDomain: "my-finance-app-99fda.firebaseapp.com",
        projectId: "my-finance-app-99fda",
        storageBucket: "my-finance-app-99fda.firebasestorage.app",
        messagingSenderId: "476029346804",
        appId: "1:476029346804:web:84edfef6015a3900270fa1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentData = { salary: 50000, fixedItems: [], limit: 12000, foodLogs: [], otherLogs: [] };
    let chart;
    let unsubscribe = null;
    const BILLING_START_DAY = 10;

    // å¸³æœŸåˆ¤å®šï¼š10è™Ÿä»¥å‰ç®—ä¸Šå€‹æœˆ
    function getBillingMonth(date) {
        let year = date.getFullYear();
        let month = date.getMonth();
        if (date.getDate() < BILLING_START_DAY) {
            month -= 1;
            if (month < 0) { month = 11; year -= 1; }
        }
        return `${year}-${String(month + 1).padStart(2, '0')}`;
    }

    function initMonthSelector() {
        const selector = document.getElementById('currentMonth');
        const now = new Date();
        const targetValue = getBillingMonth(now);
        for (let i = -3; i <= 6; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            const monthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const option = document.createElement('option');
            option.value = monthStr; 
            option.text = `${monthStr} å¸³æœŸ (10è™Ÿèµ·ç®—)`;
            if (monthStr === targetValue) option.selected = true;
            selector.appendChild(option);
        }
    }

    window.switchMonth = () => {
        const month = document.getElementById('currentMonth').value;
        if (unsubscribe) unsubscribe();
        unsubscribe = onSnapshot(doc(db, "family_account_v3", month), (docSnap) => {
            if (docSnap.exists()) {
                currentData = docSnap.data();
            } else {
                currentData = { ...currentData, foodLogs: [], otherLogs: [] };
            }
            renderUI();
            document.getElementById('status').innerText = `âœ… ${month} åŒæ­¥æˆåŠŸ`;
        });
    };

    function renderUI() {
        const foodLogs = currentData.foodLogs || [];
        const otherLogs = currentData.otherLogs || [];
        const spentFood = foodLogs.reduce((sum, log) => sum + (parseFloat(log.amount) || 0), 0);
        const spentOther = otherLogs.reduce((sum, log) => sum + (parseFloat(log.amount) || 0), 0);
        
        document.getElementById('rawDataDisplay').innerText = JSON.stringify(currentData, null, 2);

        // æ¸²æŸ“æ˜ç´°
        const logContainer = document.getElementById('combinedLogs');
        const allLogs = [
            ...foodLogs.map(l => ({...l, typeIcon: 'ğŸ”'})),
            ...otherLogs.map(l => ({...l, typeIcon: 'ğŸ“¦'}))
        ].sort((a, b) => new Date(b.time) - new Date(a.time));

        if (allLogs.length > 0) {
            document.getElementById('detailCard').style.display = 'block';
            logContainer.innerHTML = allLogs.map(l => 
                `<div class="log-item"><span>${l.time.split(',')[1] || l.time}</span> <b>${l.typeIcon} $${l.amount}</b> <i>${l.note || ''}</i></div>`
            ).join('');
        } else {
            document.getElementById('detailCard').style.display = 'none';
        }

        const salary = parseFloat(currentData.salary) || 0;
        const limit = parseFloat(currentData.limit) || 0;
        const totalFixed = (currentData.fixedItems || []).reduce((sum, i) => sum + (parseFloat(i.amount) || 0), 0);
        const netBalance = salary - totalFixed - limit;
        const livingRemaining = limit - (spentFood + spentOther);

        document.getElementById('netSavings').innerText = `$${Math.round(netBalance).toLocaleString()}`;
        document.getElementById('livingLeft').innerText = `$${Math.round(livingRemaining).toLocaleString()}`;

        // æ›´æ–°åœ–è¡¨
        const ctx = document.getElementById('budgetChart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['å¿…è¦', 'åƒå–', 'å…¶ä»–', 'å­˜æ¬¾'],
                datasets: [{ data: [totalFixed, spentFood, spentOther, Math.max(0, netBalance)], backgroundColor: ['#3498db', '#ff7675', '#74b9ff', '#2ecc71'] }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        renderFixedItems();
    }

    function renderFixedItems() {
        const container = document.getElementById('fixedItemsContainer');
        container.innerHTML = '';
        (currentData.fixedItems || []).forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `<input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)"><input type="number" value="${item.amount}" onchange="updateItem(${index}, 'amount', this.value)"><button class="delete-btn" onclick="removeFixedItem(${index})">âœ•</button>`;
            container.appendChild(row);
        });
    }

    // --- å„²å­˜ä¸»ç¨‹å¼ï¼šåŒæ™‚å„²å­˜ Firebase èˆ‡ Google Sheets ---
    window.addExpense = async (type) => {
        const inputId = type === 'food' ? 'foodAmount' : 'otherAmount';
        const val = parseFloat(document.getElementById(inputId).value) || 0;
        if (val <= 0) return;

        const now = new Date();
        const targetMonth = getBillingMonth(now); 
        const docRef = doc(db, "family_account_v3", targetMonth);
        
        document.getElementById('status').innerText = `â³ åŒæ­¥ä¸­...`;

        // 1. å–å¾—æœ€æ–°é›²ç«¯è³‡æ–™
        const docSnap = await getDoc(docRef);
        let targetData = docSnap.exists() ? docSnap.data() : { salary: 50000, fixedItems: [], limit: 12000, foodLogs: [], otherLogs: [] };

        const note = type === 'food' ? 'åƒå–ç´€éŒ„' : document.getElementById('otherNote').value;
        const newEntry = { amount: val, time: now.toLocaleString(), note: note };

        if (type === 'food') {
            if (!targetData.foodLogs) targetData.foodLogs = [];
            targetData.foodLogs.push(newEntry);
        } else {
            if (!targetData.otherLogs) targetData.otherLogs = [];
            targetData.otherLogs.push(newEntry);
        }

        // 2. å­˜å…¥ Firebase
        await setDoc(docRef, targetData);

        // 3. å­˜å…¥ Google Sheets
        if (GOOGLE_SHEET_URL !== "https://script.google.com/macros/s/AKfycbxgIXPEQLKINxnmGCUYbINmvW6cGK7c6EU4AzeYFOWM0jZeIU7cr7c6KXoThpuXDe0/exec") {
            fetch(GOOGLE_SHEET_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({
                    time: now.toLocaleString(),
                    billingMonth: targetMonth,
                    type: type,
                    amount: val,
                    note: note
                })
            });
        }

        document.getElementById(inputId).value = '';
        if (type === 'other') document.getElementById('otherNote').value = '';
        
        if (document.getElementById('currentMonth').value !== targetMonth) {
            document.getElementById('currentMonth').value = targetMonth;
            switchMonth();
        }
        document.getElementById('status').innerText = `âœ… å·²åŒæ­¥è‡³é›™é›²ç«¯`;
    };

    window.save = async () => { const m = document.getElementById('currentMonth').value; await setDoc(doc(db, "family_account_v3", m), currentData); };
    window.triggerUpdate = () => { currentData.salary = parseFloat(document.getElementById('salary').value); currentData.limit = parseFloat(document.getElementById('livingLimit').value); window.save(); };
    window.updateItem = (i, f, v) => { currentData.fixedItems[i][f] = f==='amount'?parseFloat(v):v; window.save(); };
    window.addFixedItemRow = () => { if(!currentData.fixedItems) currentData.fixedItems=[]; currentData.fixedItems.push({name:'', amount:0}); window.save(); };
    window.removeFixedItem = (i) => { currentData.fixedItems.splice(i,1); window.save(); };
    window.toggleAdmin = () => { const p = document.getElementById('adminPanel'); p.style.display = p.style.display==='block'?'none':'block'; };
    window.resetData = async () => { if(confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')){ currentData.foodLogs=[]; currentData.otherLogs=[]; window.save(); }};

    initMonthSelector();
    switchMonth();
</script>
</body>
</html>