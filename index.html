<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é›²ç«¯è¨˜å¸³ App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2ecc71; --danger: #e74c3c; --dark: #2c3e50; --gray: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--gray); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .value { font-size: 1.5rem; font-weight: bold; color: var(--dark); display: block; margin-top: 5px; }
        .label { font-size: 0.8rem; color: #888; }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .item-row { display: grid; grid-template-columns: 1fr 100px 40px; gap: 5px; margin-bottom: 5px; }
        .delete-btn { background: #ff7675; padding: 5px; font-size: 12px; }
        .cloud-status { text-align: center; font-size: 12px; color: #2ecc71; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>â˜ï¸ é›²ç«¯åŒæ­¥ Dashboard</h2>
    <div id="status" class="cloud-status">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>

    <div class="stat-grid">
        <div class="stat-box"><span class="label">æœ¬æœˆå‰©é¤˜è–ªè³‡</span><span id="netSavings" class="value">$0</span></div>
        <div class="stat-box"><span class="label">ç”Ÿæ´»è²»é¤˜é¡</span><span id="livingLeft" class="value">$0</span></div>
    </div>

    <div class="card"><canvas id="budgetChart" style="max-height: 180px;"></canvas></div>

    <div class="card">
        <h3>æ–°å¢ä¸€ç­†ç”Ÿæ´»è²»</h3>
        <input type="number" id="newExpense" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
        <button onclick="handleAddExpense()">ç¢ºèªç´€éŒ„</button>
    </div>

    <div class="card">
        <h3>é ç®—èˆ‡å¿…è¦é–‹éŠ·è©³åˆ—</h3>
        <label class="label">æ¯æœˆç¸½è–ªè³‡</label>
        <input type="number" id="salary" onchange="triggerUpdate()">
        
        <label class="label">å¿…è¦é–‹éŠ·é …ç›®</label>
        <div id="fixedItemsContainer"></div>
        <button style="background: #3498db; font-size: 13px; padding: 8px;" onclick="addFixedItemRow()">+ æ–°å¢é …ç›®</button>
        
        <hr style="margin: 20px 0; border: 0.5px solid #eee;">
        <label class="label">ç”Ÿæ´»è²»ä¸Šé™</label>
        <input type="number" id="livingLimit" onchange="triggerUpdate()">
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ è«‹åœ¨æ­¤æ›¿æ›æˆä½ è‡ªå·±çš„ Firebase Config ğŸ”´
    const firebaseConfig = {
        apiKey: "AIzaSyCgMm4JQ95mH-JOAcBsnlHz9Q7ceiF3H2E",
        authDomain: "my-finance-app-99fda.firebaseapp.com",
        projectId: "my-finance-app-99fda",
        storageBucket: "my-finance-app-99fda.firebasestorage.app",
        messagingSenderId: "476029346804",
        appId: "1:476029346804:web:84edfef6015a3900270fa1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const docRef = doc(db, "family_account", "monthly_data");

    let currentData = {
        salary: 50000,
        fixedItems: [{name: 'æˆ¿ç§Ÿ', amount: 15000}],
        limit: 15000,
        spent: 0
    };
    let chart;

    // ç›£è½é›²ç«¯è³‡æ–™ (ç•¶å®¶äººæ›´æ–°æ™‚ï¼Œä½ ä¹Ÿæœƒç«‹åˆ»æ›´æ–°)
    onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            currentData = docSnap.data();
            renderUI();
            document.getElementById('status').innerText = "âœ… é›²ç«¯åŒæ­¥ä¸­";
        } else {
            document.getElementById('status').innerText = "ğŸ†• åˆæ¬¡ä½¿ç”¨ï¼Œè«‹é–‹å§‹è¨­å®š";
        }
    });

    function renderUI() {
        document.getElementById('salary').value = currentData.salary;
        document.getElementById('livingLimit').value = currentData.limit;
        
        const container = document.getElementById('fixedItemsContainer');
        container.innerHTML = '';
        currentData.fixedItems.forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)">
                <input type="number" value="${item.amount}" onchange="updateItem(${index}, 'amount', this.value)">
                <button class="delete-btn" onclick="removeFixedItem(${index})">âœ•</button>
            `;
            container.appendChild(row);
        });

        const totalFixed = currentData.fixedItems.reduce((sum, i) => sum + (i.amount || 0), 0);
        const netBalance = currentData.salary - totalFixed - currentData.spent;
        
        document.getElementById('netSavings').innerText = `$${Math.round(netBalance).toLocaleString()}`;
        document.getElementById('livingLeft').innerText = `$${Math.round(currentData.limit - currentData.spent).toLocaleString()}`;

        const ctx = document.getElementById('budgetChart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['å¿…è¦', 'ç”Ÿæ´»è²»', 'å‰©é¤˜'],
                datasets: [{ data: [totalFixed, currentData.spent, Math.max(0, netBalance)], backgroundColor: ['#3498db', '#e74c3c', '#2ecc71'] }]
            }
        });
    }

    // å…¨åŸŸå‡½æ•¸è®“æŒ‰éˆ•å¯ä»¥å‘¼å«
    window.triggerUpdate = async () => {
        currentData.salary = parseFloat(document.getElementById('salary').value) || 0;
        currentData.limit = parseFloat(document.getElementById('livingLimit').value) || 0;
        await setDoc(docRef, currentData);
    };

    window.updateItem = async (index, field, value) => {
        currentData.fixedItems[index][field] = field === 'amount' ? parseFloat(value) || 0 : value;
        await setDoc(docRef, currentData);
    };

    window.addFixedItemRow = async () => {
        currentData.fixedItems.push({name: '', amount: 0});
        await setDoc(docRef, currentData);
    };

    window.removeFixedItem = async (index) => {
        currentData.fixedItems.splice(index, 1);
        await setDoc(docRef, currentData);
    };

    window.handleAddExpense = async () => {
        const input = document.getElementById('newExpense');
        const val = parseFloat(input.value);
        if (val > 0) {
            currentData.spent += val;
            input.value = '';
            await setDoc(docRef, currentData);
        }
    };
</script>
</body>
</html>